---
name: Automated Beta Release

on:
  push:
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find merged PR for this commit
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const sha = context.sha;

            const prs = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:pr is:merged ${sha}`
            });

            if (prs.data.items.length === 0) {
              core.info("No merged PR found for this commit. Skipping release.");
              core.setOutput("should_release", "false");
              return;
            }

            const pr = prs.data.items[0];
            const labels = pr.labels.map(l => l.name);

            core.info(`Merged PR #${pr.number} with labels: ${labels.join(", ")}`);

            if (labels.includes("beta")) {
              core.setOutput("should_release", "true");
            } else {
              core.setOutput("should_release", "false");
            }

      - name: Stop if PR is not marked beta
        if: steps.pr.outputs.should_release != 'true'
        run: |
          echo "PR is not labeled 'beta'. Skipping beta release."
          exit 0

      - name: Generate changelog and beta release
        uses: google-github-actions/release-please-action@v4
        with:
          release-type: simple
          prerelease: true
          prerelease-type: beta
          changelog-types: |
            [
              { "type": "feat", "section": "Features" },
              { "type": "fix", "section": "Bug Fixes" },
              { "type": "perf", "section": "Performance" },
              { "type": "docs", "section": "Documentation" },
              { "type": "refactor", "section": "Refactors" }
            ]
